#!/bin/sh

# Check the context informations
if [ -z "$GITONOMY_USER" -o -z "$GITONOMY_PROJECT" ]; then
    echo >&2 "Context informations missing"
    exit 1
fi

# Gitonomy console
command="php `php -r 'echo realpath(dirname(dirname(dirname(__DIR__))));'`/console"

check_reference()
{
  BEFORE="$(git rev-parse $1)"
  AFTER="$(git rev-parse $2)"
  REFERENCE="$3"

  if [ "$AFTER" = "0000000000000000000000000000000000000000" ]; then
      REQUEST="GIT_DELETE"
  else if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
      REQUEST="GIT_CREATE"
  else if [ "$BEFORE" != "$(git merge-base $BEFORE $AFTER)" ]; then
      REQUEST="GIT_FORCE"
  else
      REQUEST="GIT_WRITE"
  fi fi fi

  $command gitonomy:project-notify-push "$GITONOMY_PROJECT" "$GITONOMY_USER" "$REQUEST" "$REFERENCE" "$BEFORE" "$AFTER"
  if [ "$?" != 0 ]; then
      cat >&2 <<END

                                            ____
 ___                                      .-~. /_"-._
\`-._~-.                                  / /_ "~o\  :Y
    \  \                                / : \~x.  \` ')
     ]  Y                              /  |  Y< ~-.__j
    /   !                        _.--~T : l  l<  /.-~
   /   /                 ____.--~ .   \` l /~\ \<|Y
  /   /             .-~~"        /| .    ',-~\ \L|
 /   /             /     .^   \ Y~Y \.^>/l_   "--'
/   Y           .-"(  .  l__  j_j l_/ /~_.-~    .
Y    l          /    \  )    ~~~." / \`/"~ / \.__/l_
|     \     _.-"      ~-{__     l  :  l._Z~-.___.--~
|      ~---~           /   ~~"---\_  ' __[>
l  .                _.^   ___     _>-y~
\  \     .      .-~   .-~   ~>--"  /
 \  ~---"            /     ./  _.-'
  "-.,_____.,_  _.--~\     _.-~
              ~~     (   _}
                     \`. ~(
                       )  \\
                      /,\`--'~\--'~\\
    ----------------------------------
      If you are happy & you know it
               clap your ...
    ----------------------------------

END
    exit 1
  fi
}

while read before after reference
do
    check_reference $before $after $reference
done
