{% extends "GitonomyWebsiteBundle::layout_project.html.twig" %}

{% trans_default_domain 'project_history' %}

{% block title 'page.commit.title'|trans({'%hash%': commit.hash}) %}

{% set global_navigation = 'projects' %}
{% set local_navigation = 'history' %}

{% block project_content %}
    {% set diff = commit.diff %}

    <div class="commit-header">
        <div class="message">{{ commit.message|nl2br }}</div>
        <div class="author">
            <img src="{{ gravatar(commit.authorName, 16) }}" />
1            <strong>{{ commit.authorName }}</strong> on {{ commit.authorDate.format('Y-m-d H:i:s') }}
        </div>
        <div class="footer">
            <span>{{ commit.hash }}</span>

            <span class="pull-right">
                {% for parent in commit.parents %}
                    {% if loop.first %}<strong>{{ 'label.commit.parents'|trans }}</strong>{% endif %}
                    <a href="{{ path('project_commit', {'slug': project.slug, 'hash': parent.hash}) }}">{{ parent.hash }}</a>
                    {%- if not loop.last %},{% endif %}
                {% endfor %}
            </span>
        </div>
    </div>

    <legend>{{ 'title.commit.summary'|trans }}</legend>

    <table class="commit-summary">
        {% for file in diff.files %}
            <tr>
                <td class="actions">
                    <div class="btn-group">
                        <a rel="tooltip" title="{{ 'label.button.file_diff'|trans }}" class="btn btn-small" href="#{{ file.newName }}"><i class="icon-list"></i></a>
                        <a rel="tooltip" title="{{ 'label.button.full_file'|trans }}" class="btn btn-small" href="{{ path('project_tree', {slug: project.slug, reference: commit.hash, path: file.newName}) }}"><i class="icon-file"></i></a>
                    </div>
                </td>
                <td class="count">
                    {% if file.additions %}
                        <span class="plus">+{{ file.additions }}</span>
                    {% endif %}
                    {% if file.deletions %}
                        <span class="minus">-{{ file.deletions }}</span>
                    {% endif %}
                <td>
                    {{ file.newName }}
                </td>
            </tr>
        {% endfor %}
    </table>

    <legend>Changes</legend>

    {% for file in diff.files %}
        <ul>
            <li><strong>Old</strong>: {{ file.oldName }} ({{ file.oldMode }})</li>
            <li><strong>New</strong>: {{ file.newName }} ({{ file.newMode }})</li>
            {% for change in file.changes %}
                <p><code>@@ -{{ change.rangeOldStart }},{{ change.rangeOldCount }} +{{ change.rangeNewStart }},{{ change.rangeNewCount }}</code></p>
                <pre>
                    {% for line in change.lines %}
                        <span style="{% if line[0] == 1 %}background-color: #aaffaa{% elseif line[0] == -1 %};background-color: #ffaaaa{% endif %}">
                            {{ line[1] }}
                        </span>
                    {% endfor %}
                </pre>
            {% endfor %}
        </ul>
    {% endfor %}
{% endblock %}
